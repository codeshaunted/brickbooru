# frozen_string_literal: true

class MediaFile::Ldraw < MediaFile
  STUDIO_COLOR_MAPPING = {
    "11" => "32",
    "7" => "1",
    "6" => "2",
    "39" => "3",
    "5" => "4",
    "47" => "5",
    "8" => "6",
    "9" => "7",
    "10" => "8",
    "62" => "9",
    "36" => "10",
    "40" => "11",
    "25" => "12",
    "23" => "13",
    "3" => "14",
    "1" => "15",
    "-1" => "16",
    "38" => "17",
    "33" => "18",
    "2" => "19",
    "44" => "20",
    "46" => "21",
    "24" => "22",
    "109" => "23",
    "-2" => "24",
    "4" => "25",
    "71" => "26",
    "34" => "27",
    "69" => "28",
    "104" => "29",
    "157" => "30",
    "154" => "31",
    "14" => "33",
    "20" => "34",
    "108" => "35",
    "17" => "36",
    "50" => "37",
    "18" => "38",
    "113" => "39",
    "13" => "40",
    "74" => "41",
    "16" => "42",
    "15" => "43",
    "114" => "284",
    "107" => "45",
    "19" => "46",
    "12" => "47",
    "51" => "52",
    "121" => "54",
    "98" => "57",
    "57" => "60",
    "52" => "61",
    "64" => "62",
    "82" => "63",
    "122" => "64",
    "1001" => "65",
    "1009" => "66",
    "1008" => "67",
    "96" => "68",
    "93" => "69",
    "88" => "70",
    "86" => "71",
    "85" => "72",
    "42" => "73",
    "37" => "74",
    "116" => "75",
    "117" => "76",
    "56" => "77",
    "90" => "78",
    "60" => "79",
    "67" => "80",
    "70" => "81",
    "65" => "82",
    "1006" => "83",
    "150" => "84",
    "89" => "85",
    "91" => "86",
    "77" => "148",
    "97" => "89",
    "28" => "92",
    "26" => "100",
    "43" => "110",
    "73" => "112",
    "100" => "114",
    "76" => "115",
    "101" => "117",
    "41" => "118",
    "35" => "120",
    "32" => "125",
    "168" => "128",
    "68" => "484",
    "102" => "129",
    "111" => "132",
    "151" => "133",
    "84" => "134",
    "66" => "135",
    "78" => "137",
    "61" => "142",
    "1081" => "147",
    "119" => "150",
    "99" => "151",
    "81" => "178",
    "95" => "179",
    "2095" => "10179",
    "83" => "183",
    "2005" => "184",
    "2006" => "186",
    "2084" => "189",
    "110" => "191",
    "105" => "212",
    "27" => "216",
    "227" => "218",
    "2073" => "219",
    "103" => "226",
    "164" => "231",
    "87" => "232",
    "2121" => "234",
    "1007" => "256",
    "63" => "272",
    "1004" => "273",
    "221" => "285",
    "80" => "288",
    "2074" => "293",
    "118" => "294",
    "2104" => "295",
    "115" => "297",
    "2085" => "300",
    "162" => "302",
    "120" => "308",
    "72" => "313",
    "59" => "320",
    "153" => "321",
    "156" => "322",
    "152" => "323",
    "1003" => "324",
    "158" => "326",
    "159" => "329",
    "155" => "330",
    "21" => "334",
    "58" => "335",
    "163" => "339",
    "222" => "341",
    "1002" => "350",
    "94" => "351",
    "220" => "353",
    "228" => "360",
    "223" => "362",
    "229" => "363",
    "224" => "364",
    "230" => "365",
    "29" => "366",
    "233" => "367",
    "236" => "368",
    "240" => "370",
    "54" => "373",
    "1005" => "375",
    "48" => "378",
    "55" => "379",
    "22" => "383",
    "1013" => "406",
    "1011" => "449",
    "106" => "450",
    "31" => "462",
    "1012" => "490",
    "-10" => "493",
    "-11" => "494",
    "-12" => "495",
    "1014" => "496",
    "49" => "503",
    "1015" => "504",
    "2029" => "507",
    "2068" => "508",
    "160" => "509",
    "2034" => "510",
    "1000" => "511",
    "1016" => "10002",
    "1036" => "10010",
    "1017" => "10026",
    "1018" => "10030",
    "1019" => "10031",
    "1108" => "10035",
    "1028" => "10036",
    "2013" => "100040",
    "1029" => "10043",
    "1020" => "10070",
    "1042" => "10073",
    "1021" => "10226",
    "238" => "100238",
    "1022" => "10308",
    "1023" => "10320",
    "1024" => "10321",
    "1025" => "10322",
    "1026" => "10323",
    "1030" => "10351",
    "232" => "10366",
    "1048" => "10378",
    "1027" => "10484",
    "161" => "100003",
    "165" => "100007",
    "166" => "100009",
    "273" => "100273",
    "241" => "100241",
    "167" => "100167",
  }

  def dimensions
    [1, 1] # placeholder, if we just let it be [0, 0] it errors
  end

  def convert
    # this function fixes Studio model2.ldr format files' colors
    needs_convert = false
    converted_file = Danbooru::Tempfile.new(["brickbooru-ldraw-conversion-#{md5}-", ".ldr"])
    File.open(file, "r:UTF-8").each do |line|
      args = line.split
      if args[0] != "0" && (STUDIO_COLOR_MAPPING[args[1]])
        if args[1] == "-1"
          needs_convert = true
        end
        args[1] = STUDIO_COLOR_MAPPING[args[1]]
      end

      converted_file.puts(args.join(" "))
    end

    if needs_convert
      MediaFile.open(converted_file)
    else
      MediaFile.open(file)
    end
  end

  def preview!(max_width, max_height, **options)
    w, h = MediaFile.scale_dimensions(width, height, max_width, max_height)
    File.open("test/files/apng/not_apng.png", "rb") do |file| # TODO: add preview renderer, for now dirty hack for placeholder image
      # Read the contents of the file and return
      MediaFile::Image.new(file).resize!(w, h, **options)
    end
  end
end
